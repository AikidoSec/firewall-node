name: ðŸ§ª QA Tests
permissions:
  contents: read
on:
  push: {}
  workflow_call: {}

jobs:
  qa-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout firewall-node
        uses: actions/checkout@v5
        with:
          path: firewall-node

      - name: Checkout zen-demo-nodejs
        uses: actions/checkout@v5
        with:
          repository: Aikido-demo-apps/zen-demo-nodejs
          path: zen-demo-nodejs
          submodules: true

      - name: Use Node.js 22.x
        uses: actions/setup-node@v5
        with:
          node-version: "22.x"

      - name: Setup Aikido safe-chain
        run: |
          npm i -g @aikidosec/safe-chain@1.0.24
          safe-chain setup-ci

      - name: Set up Rust
        run: |
          rustup toolchain install stable
          rustup default stable
          cargo install wasm-pack

      - name: Build firewall-node dev package
        run: |
          cd firewall-node
          npm run install-lib-only
          npm run build

          # Pack the built package for local installation
          cd build
          npm pack

          # Move the packed tarball to zen-demo-nodejs directory
          mv aikidosec-firewall-*.tgz ../../zen-demo-nodejs/

      - name: Replace Dockerfile with QA version
        run: |
          cp firewall-node/.github/workflows/Dockerfile.qa zen-demo-nodejs/Dockerfile

      - name: Run Firewall QA Tests
        uses: AikidoSec/firewall-tester-action@releases/v1
        with:
          dockerfile_path: ./zen-demo-nodejs/Dockerfile
          app_port: 3000
          sleep_before_test: 10
