name: ðŸ§ª QA Tests

permissions:
  contents: read

on:
  workflow_call: {}

jobs:
  qa-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout firewall-node
        uses: actions/checkout@v6
        with:
          path: firewall-node

      - name: Checkout zen-demo-nodejs
        uses: actions/checkout@v6
        with:
          repository: Aikido-demo-apps/zen-demo-nodejs
          path: zen-demo-nodejs
          submodules: true

      - name: Use Node.js 24.x
        uses: actions/setup-node@v6
        with:
          node-version: "24.x"

      - name: Download build artifacts
        uses: actions/download-artifact@v5
        with:
          name: firewall-node-library-${{ github.sha }}
          path: firewall-node

      - name: Pack firewall-node library
        run: |
          cd firewall-node/build

          # Pack the built package for local installation
          npm pack

          # Move the packed tarball to zen-demo-nodejs directory
          mv aikidosec-firewall-*.tgz ../../zen-demo-nodejs/

      - name: Replace Dockerfile with QA version
        run: |
          cp firewall-node/.github/workflows/Dockerfile.qa zen-demo-nodejs/Dockerfile

      - name: Run Firewall QA Tests
        uses: AikidoSec/firewall-tester-action@v1.0.8
        with:
          dockerfile_path: ./zen-demo-nodejs/Dockerfile
          app_port: 3000
          sleep_before_test: 10
